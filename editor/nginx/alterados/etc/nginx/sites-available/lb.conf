server {
# -- NOVO --------------------------------------------
	listen 80 default_server;
	listen [::]:80 default_server;
	listen 8080 default_server;
	listen [::]:8080 default_server;
    listen 8443 ssl default_server;
	listen [::]:8443 ssl default_server;
# -- NOVO --------------------------------------------
	
    index index.html;
    error_log  /var/log/nginx/onestream_lb_error.log;
    access_log off;
    root /home/onestream/iptv/public;
    server_name _;
    send_timeout 20m;
    sendfile_max_chunk 512k;
    fastcgi_read_timeout 120s;
	ssl_certificate         /etc/letsencrypt/live/certbot-letsencrypt-certs/fullchain.pem;
    ssl_certificate_key         /etc/letsencrypt/live/certbot-letsencrypt-certs/privkey.pem;
    if ( $request_method !~ ^(GET|POST)$ ) { return 200; }
    location /web-player/ { return 404; }
    location ~ ^/stalker_portal/c(.*)$ { return 302 /c?$args; }
    location /c { expires 1h; alias /home/onestream/iptv/public/c_561/; }
    location /c/ { expires 1h; alias /home/onestream/iptv/public/c_561/; }
    location ~ ^/c/(.*)$ {
        expires 1h;
        alias /home/onestream/iptv/public/c_561/$1;
    }

      #used for server images from local
     location ~ ^/download/image/([0-9]+.*) {
        expires 1h;
        alias /home/onestream/iptv/storage/app/images/$1;
     }

    location ~*.(jpg|jpeg|png|gif|ico|css|js|svg)$ {
        expires 1h;
        try_files $uri =404;
    }

    location /images/ {
        expires 1h;
        try_files $uri =404;
    }

    location /nginx_status {
        stub_status on;
        allow 127.0.0.1;
        deny all;
    }

    location ~ ^/play/[a-zA-Z0-9_-]+/ts$ {
        return 404;
    }

    location ~ ^/probe/[a-zA-Z0-9_-]+$ {
        return 404;
    }

    chunked_transfer_encoding off;

    rewrite ^/live/(.*)/(.*)/(.*)\.(.*)$ /play/link_nt/$3?username=$1&password=$2&output=$4;
    rewrite ^/movie/(.*)/(.*)/(.*)\.(.*)$ /play/link_nt/$3?username=$1&password=$2&extension=$4;
    rewrite ^/series/(.*)/(.*)/(.*)\.(.*)$ /play/link_nt/$3?username=$1&password=$2&extension=$4;
    rewrite ^/timeshift/(.*)/(.*)/(.*)/(.*)/(.*)\.(.*)$ /play/link_archive_nt/$5/$4/duration_$3.$6?username=$1&password=$2 break;
    rewrite ^/timeShift/(.*)/(.*)/(.*)/(.*)/(.*)\.(.*)$ /play/link_archive_nt/$5/$4/duration_$3.$6?username=$1&password=$2 break;
    rewrite ^/timeshifts/(.*)/(.*)/(.*)/(.*)/(.*)\.(.*)$ /play/link_archive_nt/$4/$5/duration_$3.$6?username=$1&password=$2 break;
    rewrite ^/streaming/timeshift.php$ /play/link_archive_nt/$arg_stream/$arg_start/duration_$arg_duration.m3u8 break;
    rewrite ^/server/load.php$ /play/integration/stalker break;
    rewrite ^/c/server/load.php$ /play/integration/stalker break;
    rewrite ^/portal.php$ /play/integration/stalker break;
    rewrite ^/c/portal.php$ /play/integration/stalker break;
    rewrite ^/panel_api.php$ /play/integration/gse/gse break;
    rewrite ^/stalker_portal/server/load.php$ /play/integration/stalker break;
#    rewrite ^/(.*)/(.*)/(.*).ch$ /streaming/clients_live.php?username=$1&password=$2&stream=$3&extension=ts break;
#    rewrite ^/(.*)\.ch$ /streaming/clients_live.php?extension=ts&stream=$1&qs=$query_string break;
#    rewrite ^/ch(.*)\.m3u8$ /streaming/clients_live.php?extension=m3u8&stream=$1&qs=$query_string break;
#    rewrite ^/hls/(.*)/(.*)/(.*)/(.*)/(.*)$ /streaming/clients_live.php?extension=m3u8&username=$1&password=$2&stream=$3&type=hls&segment=$5&token=$4 break;
#    rewrite ^/hlsr/(.*)/(.*)/(.*)/(.*)/(.*)/(.*)$ /streaming/clients_live.php?token=$1&username=$2&password=$3&segment=$6&stream=$4&key_seg=$5 break;
    rewrite ^/playlist/(.*)/(.*)/(.*)$ /play/list?username=$1&password=$2&type=$3&output=m3u8 break;
    rewrite ^/epg.php$ /play/integration/xcode/xml-epg?$1;
    rewrite ^/epg/(.*)/(.*)/gz$ /play/integration/xcode/xml-epg?username=$1&password=$2&gzip=1 break;
    rewrite ^/epg/(.*)/(.*)$ /play/integration/xcode/xml-epg?username=$1&password=$2 break;
    #rewrite ^/play/live.php$ /play/link_nt/$arg_stream?mac=$arg_mac&extension=$arg_extension;

    #if ($cookie_theme = '') {
        rewrite ^/(.*)/(.*)/(\d+)$ /play/link_nt/$3?username=$1&password=$2&output=ts;
        rewrite ^/(.*)/(.*)/(\d+).ts$ /play/link_nt/$3?username=$1&password=$2&output=ts;
    #}

    rewrite ^/xplugin\.php$ /play/integration/enigma/enigma-plugin;

    # include cache location blocks
    include /etc/nginx/includes/onestream_lb_cache_locations_*.conf;

    location ~ ^/play/integration/stalker$ {
        # send the handshake to compat for performance reasons
        if ($arg_action = 'handshake') {
            #rewrite ^(.*)$ /index_compatibility.php?api=portal&$args last;
            rewrite ^(.*)$ /play/integration/stalker/handshake last;
        }

        if ($arg_action = 'log') {
            return 200;
        }

        rewrite ^(.*)$ /play/integration/stalker/index last;
    }

    ### xcode api
    location ~ ^/player_api\.php$ {
        rewrite ^(.*)$ /play/integration/xcode/index last;
    }

    location ~ ^/index_compatibility\.php$ {
        try_files @appcompatibility @appcompatibility;
    }

    location ~ ^/xmltv\.php$ {
        rewrite ^(.*)$ /play/integration/xcode/xml-epg last;
    }

    location ~ ^/mpegts\.php$ {
        try_files @appmpegts @appmpegts;
    }

    # compatibility get m3u
    # /get.php?username=888999&password=55667788&type=m3u&output=ts
    location ~ ^/get\.php$ {
        if ($arg_type = 'enigma22_script') {
            rewrite ^(.*)$ /play/enigma-setup-script?type=m3u_plus last;
        }
        rewrite ^(.*)$ /play/list last;
    }

    location ~ \.php$ {
# -- NOVO --------------------------------------------
        fastcgi_param    SERVER_PORT       $server_port;
# -- NOVO --------------------------------------------    
        return 404;
    }

    # always go to @appfpm
#    location /play/mpegts-old/ {
#        try_files @appfpm @appfpm;
#    }

    location ~ ^/play/mpegts/([a-zA-Z0-9_=]+)/([a-z0-9-]+)\.ts$ {
        rewrite ^/play/mpegts/(.*)/(.*)\.ts$ /mpegts.php?stream=$2&token=$1 last;
    }

    # always go to @appfpm
    location /play/hls/ {
        try_files @appfpm @appfpm;
    }

    # always go to @appfpm
    location /play/archive/ {
        limit_req zone=play burst=10 nodelay;
        try_files @appfpm @appfpm;
    }

    # always go to @appfpm
    location /play/vod/ {
        try_files @appvod @appvod;
    }

    # temporary until we fix for RR
    location ~ ^/play/list {
        limit_req zone=heavy burst=5 nodelay;

        try_files @appfpm @appfpm;
    }

    location ~ ^/play/integration/xcode/xml-epg {
        limit_req zone=heavy burst=5 nodelay;

        try_files @appfpm @appfpm;
    }

    location ~ ^/play/b2c/v1/xml-epg {
        limit_req zone=heavy burst=5 nodelay;

        try_files @appfpm @appfpm;
    }

    location ~ ^/play/hls-nginx/([a-zA-Z0-9_-]+)\/([a-zA-Z0-9_-]+.ts*) {
        set $auth_request_uri "/play/hls-checker/$1/$2?$args";
        auth_request /route-for-auth;

        add_header 'Access-Control-Allow-Origin' '*' always;

        alias /home/onestream/iptv/storage/app/streams/$2;
    }

    location /route-for-auth {
          internal;
          proxy_set_header X-Forwarded-For $remote_addr;
          proxy_pass http://127.0.0.1:80$auth_request_uri;
    }

    # always go to @appfpm
    location /streaming-server-management-api/rtmp {
        try_files @appfpm @appfpm;
    }

    # always go to @appfpm
    location /streaming-server-management-api/movie/ {
        try_files @appfpm @appfpm;
    }

    location /play/integration/stalker/ {
        limit_req zone=stalker burst=10 nodelay;

        try_files @apprr @apprr;
    }

    location ~ ^/play/(link|link_nt|link_archive|link_archive_nt)/ {
        limit_req zone=play burst=10 nodelay;

        try_files @apprr @apprr;
    }

    location @appfpm {
        limit_req zone=sanity burst=10 nodelay;
        fastcgi_pass unix:/run/php/php-fpm-lb.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_buffering on;
        include fastcgi_buffer_params[_]live;
        fastcgi_max_temp_file_size 0;
        fastcgi_keep_conn on;
        fastcgi_param APP_TYPE "LB";
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI $uri;
    }

    location @appcompatibility {
        limit_req zone=sanity burst=10 nodelay;
        fastcgi_pass unix:/run/php/php-fpm-lb.sock;
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME    $document_root/index_compatibility.php;
        fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
    }

    location @appmpegts {
        limit_req zone=play burst=3 nodelay;
        fastcgi_pass unix:/run/php/php-fpm-mpegts.sock;
        include fastcgi_params;
        fastcgi_buffering on;
        include fastcgi_buffer_params[_]live;
        fastcgi_max_temp_file_size 0;
        fastcgi_keep_conn on;
        fastcgi_param SCRIPT_FILENAME   $document_root$fastcgi_script_name;
        fastcgi_param SCRIPT_NAME   $fastcgi_script_name;
    }

    location @appvod {
        limit_req zone=play burst=3 nodelay;
        fastcgi_pass unix:/run/php/php-fpm-vod.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_buffering on;
        include fastcgi_buffer_params[_]vod;
        fastcgi_max_temp_file_size 0;
        fastcgi_keep_conn on;
        fastcgi_param APP_TYPE "LB";
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param REQUEST_URI $uri;
    }

    location @apprr {
        limit_req zone=sanity burst=10 nodelay;
        proxy_pass http://127.0.0.1:31211;
        proxy_set_header Host      $http_host;
        #proxy_set_header X-App-Type      "LB";
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $x_forwarded_proto_to_rr;
    }


    location = / {
# -- ---NOVO --------------------------------------------	
#https://mmacleod.ca/2024/05/plex-behind-an-nginx-reverse-proxy-the-hard-way/
        if ($server_port = "80") {
            return 403 "111111You're not$server_port";
        }
        
		if ($scheme = "http") {
			set $valido 0;
			if ($allowedip){ set $valido 1;	}
			if ($allowedhost){ set $valido 1; }
			if ($valido = 0){ return 301 $scheme://protect1.com$request_uri; }
		}
# ----- NOVO --------------------------------------------
        try_files @apprr @apprr;
    }

    location / {
# ----- NOVO --------------------------------------------	
		if ($scheme = "http") {
			set $valido 0;
			if ($allowedip){ set $valido 1;	}
			if ($allowedhost){ set $valido 1; }
			if ($valido = 0){ return 301 $scheme://protect2.com$request_uri; }
		}
# ----- NOVO --------------------------------------------
        try_files $uri $uri/ @apprr;
    }

    location ~* ^(?!/play/vod).*\.(mp4|mkv|avi)$ {
         expires 1h;
         add_header 'Access-Control-Allow-Origin' '*' always;
         try_files $uri =404;
     }
}
